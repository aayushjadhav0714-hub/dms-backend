<!DOCTYPE html>
<html>
<head>
    <title>Disaster Management - Reports</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary: #0b3c5d;
            --secondary: #1d70a2;
            --accent: #c0392b;
            --bg-light: #f4f6f8;
            --text-dark: #2c3e50;
            --white: #ffffff;
            --danger: #dc3545;
        }

        * { box-sizing: border-box; }
        body { margin: 0; font-family: "Segoe UI", Arial, sans-serif; background-color: var(--bg-light); color: var(--text-dark); }

        header { background-color: var(--primary); color: var(--white); padding: 16px 30px; display: flex; justify-content: space-between; align-items: center; }
        .content { display: flex; min-height: calc(100vh - 70px); }

        .sidebar { width: 220px; background-color: var(--secondary); padding: 20px 0; color: var(--white); }
        .sidebar h3 { margin: 0; padding: 12px 20px; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .sidebar h3:hover { background-color: var(--accent); }

        .data { padding: 24px; width: 100%; }
        table { width: 100%; border-collapse: collapse; background-color: var(--white); box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background-color: var(--primary); color: var(--white); }
        
        .btn-delete { background: var(--danger); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; }
        .btn-delete:hover { opacity: 0.8; }
        .loading { text-align: center; padding: 20px; font-weight: bold; }
    </style>
</head>

<body>
    <header>
        <div class="left-side">Emergency Response System - Admin</div>
    </header>

    <div class="content">
        <div class="sidebar">
            <h3 onclick="location.href='Dashboard.html'">Dashboard</h3>
        </div>

        <div class="data">
            <h1>Emergency Incident Reports</h1>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Location</th>
                        <th>Time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="reportsTable">
                    <tr><td colspan="5" class="loading">डेटा लोड होत आहे...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://idogfmuksxbjjmrfdclk.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_49Wi0aMQU0u1YF4nF3PQvg_WbwUscRs';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const tableBody = document.getElementById("reportsTable");

        // 1. डेटा लोड करण्याचे फंक्शन
        async function loadReports() {
            try {
                const { data: allReports, error } = await _supabase
                    .from('Report')
                    .select('*')
                    .order('id', { ascending: false });

                if (error) throw error;

                tableBody.innerHTML = ""; 

                if (allReports.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>अजून कोणताही रिपोर्ट नाही.</td></tr>";
                    return;
                }

                allReports.forEach(report => {
                    const row = `
                        <tr>
                            <td>${report.fullname || 'N/A'}</td>
                            <td>${report.mobile || 'N/A'}</td>
                            <td>${report.location || 'N/A'}</td>
                            <td>${report.datetime || 'N/A'}</td>
                            <td>
                                <button class="btn-delete" onclick="deleteReport(${report.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>`;
                    tableBody.innerHTML += row;
                });

            } catch (error) {
                console.error("Error:", error.message);
                tableBody.innerHTML = "<tr><td colspan='5' style='text-align:center; color:red;'>डेटा लोड करताना चूक झाली! पॉलिसी चेक करा.</td></tr>";
            }
        }

        // 2. रिपोर्ट डिलीट करण्याचे फंक्शन
        async function deleteReport(id) {
            if (confirm("तुम्हाला खात्री आहे की हा रिपोर्ट डिलीट करायचा आहे?")) {
                const { error } = await _supabase
                    .from('Report')
                    .delete()
                    .eq('id', id);

                if (error) {
                    alert("Delete करताना चूक झाली: " + error.message);
                } else {
                    alert("रिपोर्ट यशस्वीपणे डिलीट केला!");
                    loadReports(); // टेबल रिफ्रेश करा
                }
            }
        }

        window.onload = loadReports;
    </script>
</body>
</html>